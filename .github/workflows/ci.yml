name: CI Pipeline - Node.js + MongoDB + Redis + BullMQ
on: 
  push:
    branches: [master]
  pull_request:
    branches: [master]
  
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Start services using docker-compose
      run: |
        docker compose -f docker-compose.yml up -d --build
        echo "Containers are up and running..."

    - name: Check running containers
      run: docker compose ps

    - name: Show backend logs
      run: docker compose logs backend-app

    - name: Wait for MongoDB and Redis
      run: |
        echo "Waiting for mongodb and redis to start..."
        sleep 35
    # - name: Run tests
    #   run: docker compose run --rm backend-app npm test

    # - name: Run Tests
    #   run: |
    #       docker compose run --rm backend-app \
    #       npm test -- --runInBand --detectOpenHandles 

    - name: Run Tests
      run: |
          docker compose run --rm backend-app \
          npm test -- --runInBand --forceExit


    - name: Stop and clean up
      if: always()
      run: docker compose down